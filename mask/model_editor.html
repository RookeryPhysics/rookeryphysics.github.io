<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Editor</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
            background-color: #111;
            color: #eee;
            font-family: sans-serif;
        }

        /* Sidebar Layout */
        #sidebar {
            width: 320px;
            background: #222;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Top Section: List of Parts */
        #parts-list-container {
            flex: 1;
            overflow-y: auto;
            border-bottom: 1px solid #444;
            padding: 10px;
        }

        #parts-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .part-item {
            padding: 8px;
            background: #333;
            margin-bottom: 5px;
            cursor: pointer;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .part-item:hover {
            background: #3a3a3a;
        }

        .part-item.selected {
            background: #4caf50;
            border-color: #45a049;
            color: white;
        }

        /* Middle Section: Properties Editor */
        #properties-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        /* Bottom Section: Actions */
        #actions-panel {
            padding: 15px;
            background: #222;
        }

        h3 {
            margin-top: 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .control-group {
            margin-bottom: 10px;
        }

        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        input[type="number"] {
            width: 70px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 4px;
            border-radius: 3px;
        }

        input[type="text"] {
            width: 120px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 4px;
            border-radius: 3px;
        }

        input[type="color"] {
            border: none;
            width: 40px;
            height: 20px;
            cursor: pointer;
            background: none;
        }

        .btn-row {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        button {
            flex: 1;
            background: #444;
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        button:hover {
            background: #555;
        }

        button.primary {
            background: #2196F3;
        }

        button.primary:hover {
            background: #1976D2;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #d32f2f;
        }

        textarea {
            width: 100%;
            height: 100px;
            background: #111;
            color: #aaddaa;
            border: 1px solid #333;
            font-family: monospace;
            font-size: 0.7rem;
            padding: 5px;
            resize: vertical;
        }

        #canvas-container {
            flex-grow: 1;
            position: relative;
        }

        #no-selection {
            color: #666;
            font-style: italic;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <!-- Parts List -->
        <div id="parts-list-container">
            <h3>Model Parts</h3>
            <ul id="parts-list"></ul>
            <div class="btn-row">
                <button onclick="addPart('Box')">+ Box</button>
                <button onclick="addPart('Cylinder')">+ Cyl</button>
                <button onclick="addPart('Muzzle')">+ Muzzle</button>
            </div>
        </div>

        <!-- Properties Editor -->
        <div id="properties-panel">
            <h3>Properties</h3>
            <div id="editor-content"></div>
            <div id="no-selection">Select a part to edit</div>
        </div>

        <!-- Export -->
        <div id="actions-panel">
            <button class="primary" onclick="exportCode()">Generate Three.js Code</button>
            <textarea id="output" readonly placeholder="Code..."></textarea>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- Data State ---
        let parts = [
            {
                id: 'body',
                name: 'Gun Body',
                type: 'Box',
                params: { width: 0.25, height: 0.2, depth: 1.2 },
                position: { x: 0, y: 0.1, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#666666'
            },
            {
                id: 'barrel',
                name: 'Barrel',
                type: 'Box',
                params: { width: 0.12, height: 0.12, depth: 1.0 },
                position: { x: 0, y: 0.08, z: -0.8 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#333333'
            },
            {
                id: 'muzzle_point',
                name: 'Muzzle Point',
                type: 'Muzzle',
                params: {},
                position: { x: 0, y: 0.08, z: -1.3 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#ff0000'
            },
            {
                id: 'part_3',
                name: 'Stock/Rear',
                type: 'Box',
                params: { width: 0.28, height: 0.35, depth: 0.2 },
                position: { x: 0, y: 0.04, z: 0.525 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#1f1f1f'
            },
            {
                id: 'part_4',
                name: 'Grip',
                type: 'Box',
                params: { width: 0.2, height: 0.4, depth: 0.15 },
                position: { x: 0, y: -0.1, z: -0.3 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#262626'
            },
            {
                id: 'part_5',
                name: 'Sight Left',
                type: 'Box',
                params: { width: 0.05, height: 0.15, depth: 0.2 },
                position: { x: 0.07, y: 0.2, z: -0.35 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#888888'
            },
            {
                id: 'part_6',
                name: 'Sight Right',
                type: 'Box',
                params: { width: 0.05, height: 0.15, depth: 0.2 },
                position: { x: -0.07, y: 0.2, z: -0.35 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#888888'
            },
            {
                id: 'part_7',
                name: 'Mid Acc',
                type: 'Box',
                params: { width: 0.2, height: 0.2, depth: 0.2 },
                position: { x: 0, y: 0, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#888888'
            },
            {
                id: 'part_8',
                name: 'Muzzle Tip',
                type: 'Box',
                params: { width: 0.1, height: 0.1, depth: 0.1 },
                position: { x: 0, y: 0.08, z: -1.3 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#ff0000'
            }
        ];

        let selectedPartId = null;

        // --- Scene Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(2, 2, 2);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // Helpers
        scene.add(new THREE.GridHelper(10, 10));
        scene.add(new THREE.AxesHelper(1));

        // Gun Group
        const gunGroup = new THREE.Group();
        scene.add(gunGroup);

        // --- Logic ---

        /**
         * Generates a unique ID string.
         * @returns {string} A random simple ID.
         */
        function generateId() {
            return 'part_' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * Adds a new part to the model.
         * @param {string} type - The geometry type (e.g., 'Box', 'Sphere').
         * @returns {void}
         */
        function addPart(type) {
            const id = generateId();
            let newPart = {
                id: id,
                name: `New ${type}`,
                type: type,
                position: { x: 0, y: 0, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                color: '#888888',
                params: {}
            };

            if (type === 'Box') {
                newPart.params = { width: 0.2, height: 0.2, depth: 0.2 };
            } else if (type === 'Cylinder') {
                newPart.params = { radiusTop: 0.1, radiusBottom: 0.1, height: 0.5, segments: 16 };
            } else if (type === 'Muzzle') {
                newPart.color = '#ff0000';
            }

            parts.push(newPart);
            renderPartsList();
            selectPart(id);
            rebuildModel();
        }

        /**
         * Removes a part from the model by its ID.
         * @param {string} id - The ID of the part to remove.
         * @returns {void}
         */
        function removePart(id) {
            if (confirm('Delete this part?')) {
                parts = parts.filter(p => p.id !== id);
                if (selectedPartId === id) {
                    selectedPartId = null;
                    renderEditor();
                }
                renderPartsList();
                rebuildModel();
            }
        }

        /**
         * Selects a part for editing.
         * @param {string} id - The ID of the part to select.
         * @returns {void}
         */
        function selectPart(id) {
            selectedPartId = id;
            renderPartsList();
            renderEditor();
        }

        /**
         * Updates a property of a part.
         * @param {string} id - The ID of the part.
         * @param {string} field - The property field name.
         * @param {any} value - The new value.
         * @param {string|null} [nestedField=null] - Optional nested field within the primary field.
         * @returns {void}
         */
        function updatePart(id, field, value, nestedField = null) {
            const part = parts.find(p => p.id === id);
            if (!part) return;

            if (nestedField) {
                part[field][nestedField] = parseFloat(value);
            } else if (field === 'name' || field === 'color') {
                part[field] = value;
            } else {
                part[field] = parseFloat(value);
            }
            rebuildModel();
        }

        // --- UI Rendering ---

        /**
         * Renders the list of parts in the sidebar.
         * @returns {void}
         */
        function renderPartsList() {
            const list = document.getElementById('parts-list');
            list.innerHTML = '';
            parts.forEach(part => {
                const li = document.createElement('li');
                li.className = `part-item ${part.id === selectedPartId ? 'selected' : ''}`;
                li.innerHTML = `<span>${part.name}</span> <small style="opacity:0.6">${part.type}</small>`;
                li.onclick = () => selectPart(part.id);
                list.appendChild(li);
            });
        }

        /**
         * Renders the property editor for the selected part.
         * @returns {void}
         */
        function renderEditor() {
            const container = document.getElementById('editor-content');
            const noSel = document.getElementById('no-selection');

            if (!selectedPartId) {
                container.innerHTML = '';
                noSel.style.display = 'block';
                return;
            }

            noSel.style.display = 'none';
            const part = parts.find(p => p.id === selectedPartId);

            let html = `
            <div class="control-group">
                <label>Name <input type="text" value="${part.name}" onchange="updatePart('${part.id}', 'name', this.value)"></label>
                <label>Color <input type="color" value="${part.color}" onchange="updatePart('${part.id}', 'color', this.value)"></label>
            </div>
            <h3>Dimensions</h3>
            <div class="control-group">
        `;

            if (part.type === 'Box') {
                html += `
                <label>Width <input type="number" step="0.05" value="${part.params.width}" oninput="updatePart('${part.id}', 'params', this.value, 'width')"></label>
                <label>Height <input type="number" step="0.05" value="${part.params.height}" oninput="updatePart('${part.id}', 'params', this.value, 'height')"></label>
                <label>Depth <input type="number" step="0.05" value="${part.params.depth}" oninput="updatePart('${part.id}', 'params', this.value, 'depth')"></label>
            `;
            } else if (part.type === 'Cylinder') {
                html += `
                <label>Radius Top <input type="number" step="0.05" value="${part.params.radiusTop}" oninput="updatePart('${part.id}', 'params', this.value, 'radiusTop')"></label>
                <label>Radius Btm <input type="number" step="0.05" value="${part.params.radiusBottom}" oninput="updatePart('${part.id}', 'params', this.value, 'radiusBottom')"></label>
                <label>Height <input type="number" step="0.05" value="${part.params.height}" oninput="updatePart('${part.id}', 'params', this.value, 'height')"></label>
                <label>Segments <input type="number" step="1" value="${part.params.segments}" oninput="updatePart('${part.id}', 'params', this.value, 'segments')"></label>
            `;
            } else if (part.type === 'Muzzle') {
                html += `<div style="padding:10px; color:#aaa; font-style:italic; font-size:0.8rem;">Muzzle is a point helper. It has no dimensions.</div>`;
            }

            html += `
            </div>
            <h3>Position</h3>
            <div class="control-group">
                <label>X <input type="number" step="0.05" value="${part.position.x}" oninput="updatePart('${part.id}', 'position', this.value, 'x')"></label>
                <label>Y <input type="number" step="0.05" value="${part.position.y}" oninput="updatePart('${part.id}', 'position', this.value, 'y')"></label>
                <label>Z <input type="number" step="0.05" value="${part.position.z}" oninput="updatePart('${part.id}', 'position', this.value, 'z')"></label>
            </div>
             <h3>Rotation</h3>
            <div class="control-group">
                <label>X <input type="number" step="0.1" value="${part.rotation.x}" oninput="updatePart('${part.id}', 'rotation', this.value, 'x')"></label>
                <label>Y <input type="number" step="0.1" value="${part.rotation.y}" oninput="updatePart('${part.id}', 'rotation', this.value, 'y')"></label>
                <label>Z <input type="number" step="0.1" value="${part.rotation.z}" oninput="updatePart('${part.id}', 'rotation', this.value, 'z')"></label>
            </div>
            <button class="danger" onclick="removePart('${part.id}')">Delete Part</button>
        `;

            container.innerHTML = html;
        }

        // --- Scene Logic ---

        /**
         * Rebuilds the 3D model in the scene based on the current parts state.
         * @returns {void}
         */
        function rebuildModel() {
            // Clear children
            while (gunGroup.children.length > 0) {
                gunGroup.remove(gunGroup.children[0]);
            }

            parts.forEach(part => {
                let geometry, material, mesh;

                if (part.type === 'Box') {
                    geometry = new THREE.BoxGeometry(part.params.width, part.params.height, part.params.depth);
                    material = new THREE.MeshStandardMaterial({ color: part.color });
                    mesh = new THREE.Mesh(geometry, material);
                } else if (part.type === 'Cylinder') {
                    geometry = new THREE.CylinderGeometry(part.params.radiusTop, part.params.radiusBottom, part.params.height, part.params.segments);
                    material = new THREE.MeshStandardMaterial({ color: part.color });
                    mesh = new THREE.Mesh(geometry, material);
                } else if (part.type === 'Muzzle') {
                    geometry = new THREE.SphereGeometry(0.05);
                    material = new THREE.MeshBasicMaterial({ color: part.color, wireframe: true });
                    mesh = new THREE.Mesh(geometry, material);
                }

                if (mesh) {
                    mesh.position.set(part.position.x, part.position.y, part.position.z);
                    mesh.rotation.set(part.rotation.x, part.rotation.y, part.rotation.z);
                    gunGroup.add(mesh);
                }
            });
        }

        // --- Export ---

        /**
         * Exports the current model as Three.js JavaScript code.
         * @returns {void}
         */
        function exportCode() {
            let code = `const gunGroup = new THREE.Group();\n\n`;

            parts.forEach((part, index) => {
                // Variable name cleanup
                const varName = part.type.toLowerCase() + index;

                code += `// ${part.name}\n`;

                if (part.type === 'Box') {
                    code += `const ${varName}Geo = new THREE.BoxGeometry(${part.params.width}, ${part.params.height}, ${part.params.depth});\n`;
                    code += `const ${varName}Mat = new THREE.MeshStandardMaterial({ color: "${part.color}" });\n`;
                    code += `const ${varName} = new THREE.Mesh(${varName}Geo, ${varName}Mat);\n`;
                } else if (part.type === 'Cylinder') {
                    code += `const ${varName}Geo = new THREE.CylinderGeometry(${part.params.radiusTop}, ${part.params.radiusBottom}, ${part.params.height}, ${part.params.segments});\n`;
                    code += `const ${varName}Mat = new THREE.MeshStandardMaterial({ color: "${part.color}" });\n`;
                    code += `const ${varName} = new THREE.Mesh(${varName}Geo, ${varName}Mat);\n`;
                } else if (part.type === 'Muzzle') {
                    code += `const ${varName} = new THREE.Object3D();\n`;
                }

                // Transform
                if (part.position.x || part.position.y || part.position.z) {
                    code += `${varName}.position.set(${part.position.x}, ${part.position.y}, ${part.position.z});\n`;
                }
                if (part.rotation.x || part.rotation.y || part.rotation.z) {
                    code += `${varName}.rotation.set(${part.rotation.x}, ${part.rotation.y}, ${part.rotation.z});\n`;
                }

                code += `gunGroup.add(${varName});\n\n`;
            });

            document.getElementById('output').value = code;
        }

        // Init
        renderPartsList();
        rebuildModel();

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        /**
         * The animation loop for the 3D view.
         * @returns {void}
         */
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>

</html>
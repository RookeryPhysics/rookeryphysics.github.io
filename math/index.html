<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral Challenge & Solver</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        @media (min-width: 768px) {
            body {
                padding-top: 50px;
            }
        }

        #plot, #plot-solver {
            width: 100%;
            height: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            #plot, #plot-solver {
                height: 500px;
            }
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .result-box {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0d6efd;
        }

        #math-display, #math-preview {
            font-size: 1.5rem;
            min-height: 4em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            padding: 20px;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #dc3545;
        }

        #game-ui, #solver-ui, #start-screen {
            display: none;
        }

        #start-screen {
            text-align: center;
            padding: 40px;
        }

        .feedback {
            font-size: 1.2rem;
            margin-top: 10px;
        }

        .mode-switch {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <div class="mode-switch">
        <button id="switch-to-solver" class="btn btn-outline-secondary btn-sm">Switch to Solver</button>
        <button id="switch-to-game" class="btn btn-outline-secondary btn-sm" style="display: none;">Switch to Game</button>
    </div>

    <div class="container px-3 px-sm-4">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                
                <!-- Start Screen -->
                <div id="start-screen" class="card" style="display: block;">
                    <h1 class="mb-4">Integral Challenge</h1>
                    <p class="lead">Solve as many definite integrals as you can! You have 60 seconds per problem.</p>
                    <button id="start-btn" class="btn btn-primary btn-lg">Start Game</button>
                </div>

                <!-- Game UI -->
                <div id="game-ui">
                    <div class="card p-4 mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 style="font-size: 1.5rem;">Solve the Integral</h2>
                            <div id="timer" class="timer">60s</div>
                        </div>
                        
                        <div id="math-display"></div>

                        <div class="row g-3 align-items-end">
                            <div class="col-8 col-sm-9">
                                <label for="user-answer" class="form-label">Your Answer (numeric or expression)</label>
                                <input type="text" class="form-control form-control-lg" id="user-answer" placeholder="e.g., 1/3 or 0.333" autocomplete="off">
                            </div>
                            <div class="col-4 col-sm-3">
                                <button id="submit-btn" class="btn btn-success btn-lg w-100">Submit</button>
                            </div>
                        </div>
                        <div id="feedback" class="feedback text-center mt-3"></div>
                    </div>

                    <div id="result-card" class="card p-4" style="display: none;">
                        <div class="text-center mb-3">
                            <span class="text-muted small">Correct Answer:</span>
                            <div id="correct-answer-text" class="result-box mt-1"></div>
                        </div>
                        <div id="plot"></div>
                        <div class="text-center mt-4">
                            <button id="next-btn" class="btn btn-outline-primary">Next Challenge</button>
                        </div>
                    </div>
                </div>

                <!-- Solver UI (Original) -->
                <div id="solver-ui">
                    <div class="card p-3 p-md-4 mb-3 mb-md-4">
                        <h2 class="text-center mb-3 mb-md-4" style="font-size: 1.5rem;">Integral Solver & Visualizer</h2>
                        <form id="integral-form" onsubmit="return false;">
                            <div id="functions-container" class="row g-3">
                                <div class="col-12 col-md-6 function-input-group">
                                    <label class="form-label">Function 1 (f(x))</label>
                                    <input type="text" class="form-control formula-input" value="x^2"
                                        placeholder="e.g., x^2" autocomplete="off" required>
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-function">+ Add Function</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="subtract-function">− Subtract Function</button>
                            </div>
                            <div class="row g-3 mt-1">
                                <div class="col-12">
                                    <div id="math-preview"></div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label for="lower" class="form-label">Lower Limit (a)</label>
                                    <input type="text" class="form-control" id="lower" value="0" inputmode="decimal" required>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label for="upper" class="form-label">Upper Limit (b)</label>
                                    <input type="text" class="form-control" id="upper" value="2" inputmode="decimal" required>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="card p-3 p-md-4">
                        <div class="text-center mb-2 mb-md-3">
                            <span class="text-muted small">Result:</span>
                            <div id="solver-result" class="result-box mt-1">Result ≈ ...</div>
                        </div>
                        <div id="plot-solver"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Shared State & Utilities
        function convertPi(input) {
            const val = input.value;
            if (!val) return;
            const cursorPos = input.selectionStart;
            const newVal = val.replace(/pi/gi, 'π');
            if (val !== newVal) {
                input.value = newVal;
                const diff = val.length - newVal.length;
                input.setSelectionRange(cursorPos - diff, cursorPos - diff);
            }
        }

        // --- Game Logic ---
        let timeLeft = 60;
        let timerId = null;
        let currentProblem = null;
        
        const mathDisplay = document.getElementById('math-display');
        const timerDisplay = document.getElementById('timer');
        const userAnswerInput = document.getElementById('user-answer');
        const submitBtn = document.getElementById('submit-btn');
        const feedback = document.getElementById('feedback');
        const startScreen = document.getElementById('start-screen');
        const gameUI = document.getElementById('game-ui');
        const startBtn = document.getElementById('start-btn');
        const resultCard = document.getElementById('result-card');
        const plotDiv = document.getElementById('plot');
        const correctAnswerText = document.getElementById('correct-answer-text');
        const nextBtn = document.getElementById('next-btn');

        userAnswerInput.addEventListener('input', (e) => convertPi(e.target));

        function startTimer() {
            timeLeft = 60;
            timerDisplay.innerText = timeLeft + 's';
            timerDisplay.classList.remove('text-danger');
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft + 's';
                if (timeLeft <= 10) timerDisplay.classList.add('text-danger');
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    endGame(false);
                }
            }, 1000);
        }

        function generateProblem() {
            const types = ['power', 'trig', 'exp', 'linear'];
            const type = types[Math.floor(Math.random() * types.length)];
            let f, a, b, ans;
            if (type === 'power') {
                const n = Math.floor(Math.random() * 3) + 1;
                const c = Math.floor(Math.random() * 3) + 1;
                f = c === 1 ? `x^${n}` : `${c}*x^${n}`;
                a = Math.floor(Math.random() * 2);
                b = a + Math.floor(Math.random() * 2) + 1;
                ans = c * (Math.pow(b, n + 1) / (n + 1) - Math.pow(a, n + 1) / (n + 1));
            } else if (type === 'trig') {
                const isSin = Math.random() > 0.5;
                f = isSin ? 'sin(x)' : 'cos(x)';
                const points = [{ val: 0, tex: '0' }, { val: Math.PI / 2, tex: '\\pi/2' }, { val: Math.PI, tex: '\\pi' }];
                const i1 = Math.floor(Math.random() * 2);
                const i2 = i1 + 1;
                a = points[i1].val; b = points[i2].val;
                ans = isSin ? (-Math.cos(b) - (-Math.cos(a))) : (Math.sin(b) - Math.sin(a));
                currentProblem = { f, a: points[i1].tex.replace('\\pi', 'pi'), b: points[i2].tex.replace('\\pi', 'pi'), ans };
                renderProblem();
                return;
            } else if (type === 'exp') {
                f = 'exp(x)'; a = 0; b = 1; ans = Math.E - 1;
            } else {
                const c = Math.floor(Math.random() * 5) + 1;
                f = `${c}`; a = Math.floor(Math.random() * 5); b = a + Math.floor(Math.random() * 5) + 1;
                ans = c * (b - a);
            }
            currentProblem = { f, a, b, ans };
            renderProblem();
        }

        function renderProblem() {
            let aTex = "?", bTex = "?", fTex = "?";
            try { aTex = math.parse(String(currentProblem.a)).toTex(); } catch(e) {}
            try { bTex = math.parse(String(currentProblem.b)).toTex(); } catch(e) {}
            try { fTex = math.parse(currentProblem.f).toTex(); } catch(e) {}
            const latex = `\\int_{${aTex}}^{${bTex}} ${fTex} \\, dx`;
            katex.render(latex, mathDisplay, { throwOnError: false });
        }

        function startGame() {
            startScreen.style.display = 'none';
            gameUI.style.display = 'block';
            resultCard.style.display = 'none';
            feedback.innerText = '';
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;
            submitBtn.disabled = false;
            generateProblem();
            startTimer();
        }

        function endGame(success) {
            clearInterval(timerId);
            userAnswerInput.disabled = true;
            submitBtn.disabled = true;
            feedback.innerHTML = success ? '<span class="text-success fw-bold">Correct!</span>' : '<span class="text-danger fw-bold">Time\'s Up or Incorrect.</span>';
            showResult();
        }

        function showResult() {
            resultCard.style.display = 'block';
            correctAnswerText.innerText = `Result ≈ ${currentProblem.ans.toFixed(4)}`;
            updateGamePlot();
        }

        function updateGamePlot() {
            try {
                const a = math.evaluate(String(currentProblem.a).replace(/π/g, 'pi'));
                const b = math.evaluate(String(currentProblem.b).replace(/π/g, 'pi'));
                const fStr = currentProblem.f;
                const margin = Math.abs(b - a) * 0.5 || 2;
                const xDomain = [Math.min(a, b) - margin, Math.max(a, b) + margin];
                functionPlot({
                    target: '#plot',
                    width: plotDiv.offsetWidth,
                    height: plotDiv.offsetHeight,
                    grid: true,
                    xAxis: { domain: xDomain },
                    data: [
                        { fn: fStr.replace(/pi/g, 'PI').replace(/\be\b/g, 'exp(1)'), color: '#0d6efd' },
                        { fn: fStr.replace(/pi/g, 'PI').replace(/\be\b/g, 'exp(1)'), range: [a, b], closed: true, color: 'rgba(13, 110, 253, 0.4)' }
                    ]
                });
            } catch (err) {}
        }

        function checkAnswer() {
            const userValStr = userAnswerInput.value.trim().replace(/π/g, 'pi');
            if (!userValStr) return;
            try {
                const userVal = math.evaluate(userValStr);
                if (Math.abs(userVal - currentProblem.ans) < 0.01) endGame(true);
                else feedback.innerHTML = '<span class="text-danger">Incorrect, try again!</span>';
            } catch (e) { feedback.innerHTML = '<span class="text-warning">Invalid expression</span>'; }
        }

        startBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', startGame);
        submitBtn.addEventListener('click', checkAnswer);
        userAnswerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });

        // --- Solver Logic (Original) ---
        let currentOp = '-';
        const solverUI = document.getElementById('solver-ui');

        function numericalIntegration(funcs, a, b, n = 10000) {
            if (n % 2 !== 0) n++;
            const h = (b - a) / n;
            const diff = (x) => {
                if (funcs.length === 0) return 0;
                if (funcs.length === 1) return funcs[0](x);
                return currentOp === '+' ? funcs[0](x) + funcs[1](x) : funcs[0](x) - funcs[1](x);
            };
            let sumInt = diff(a) + diff(b);
            for (let i = 1; i < n; i++) {
                const x = a + i * h;
                sumInt += ((i % 2 === 0) ? 2 : 4) * diff(x);
            }
            return (h / 3) * sumInt;
        }

        function updateSolverPreview() {
            const inputs = document.querySelectorAll('.formula-input');
            const lowerInput = document.getElementById('lower').value;
            const upperInput = document.getElementById('upper').value;
            const previewElement = document.getElementById('math-preview');
            try {
                const prep = (s) => (s || "").replace(/π/g, 'pi');
                let lLatex = "?", uLatex = "?";
                try { lLatex = lowerInput ? math.parse(prep(lowerInput)).toTex() : "?"; } catch (e) {}
                try { uLatex = upperInput ? math.parse(prep(upperInput)).toTex() : "?"; } catch (e) {}
                let eLatex = "";
                if (inputs.length === 1) eLatex = math.parse(prep(inputs[0].value) || "0").toTex();
                else if (inputs.length >= 2) eLatex = `(${math.parse(prep(inputs[0].value) || "0").toTex()}) ${currentOp} (${math.parse(prep(inputs[1].value) || "0").toTex()})`;
                katex.render(`\\int_{${lLatex}}^{${uLatex}} ${eLatex} \\, dx`, previewElement, { throwOnError: false });
            } catch (err) { previewElement.innerHTML = `<small class="text-danger">${err.message}</small>`; }
        }

        function updateSolverPlot() {
            const inputs = document.querySelectorAll('.formula-input');
            const lowerInput = document.getElementById('lower').value;
            const upperInput = document.getElementById('upper').value;
            try {
                const prep = (s) => (s || "").replace(/π/g, 'pi');
                const a = math.evaluate(prep(lowerInput) || "0");
                const b = math.evaluate(prep(upperInput) || "0");
                const funcs = Array.from(inputs).map(input => {
                    const code = math.parse(prep(input.value) || "0").compile();
                    return (xVal) => code.evaluate({ x: xVal, e: math.e, pi: math.pi });
                });
                
                const integral = numericalIntegration(funcs, a, b);
                document.getElementById('solver-result').innerText = `Result ≈ ${integral.toFixed(6)}`;
                
                const margin = Math.abs(b - a) * 0.5 || 2;
                const plotData = Array.from(inputs).map((input, idx) => ({
                    fn: prep(input.value).replace(/pi/g, 'PI').replace(/\be\b/g, 'exp(1)') || "0",
                    color: ['#0d6efd', '#dc3545'][idx % 2],
                    graphType: 'polyline'
                }));

                // Restore shading logic
                if (funcs.length >= 2) {
                    const points = [];
                    const samples = 200;
                    const start = Math.min(a, b);
                    const end = Math.max(a, b);
                    const step = (end - start) / samples;

                    if (currentOp === '+') {
                        for (let i = 0; i <= samples; i++) {
                            const x = start + i * step;
                            points.push([x, funcs[0](x) + funcs[1](x)]);
                        }
                        for (let i = samples; i >= 0; i--) {
                            const x = start + i * step;
                            points.push([x, 0]);
                        }
                    } else {
                        for (let i = 0; i <= samples; i++) {
                            const x = start + i * step;
                            points.push([x, funcs[0](x)]);
                        }
                        for (let i = samples; i >= 0; i--) {
                            const x = start + i * step;
                            points.push([x, funcs[1](x)]);
                        }
                    }
                    points.push(points[0]);
                    plotData.push({
                        points: points,
                        fnType: 'points',
                        graphType: 'polyline',
                        closed: true,
                        color: 'rgba(0, 0, 0, 0.2)'
                    });

                    if (currentOp === '+') {
                        plotData.push({
                            fn: `(${prep(inputs[0].value)}) + (${prep(inputs[1].value)})`.replace(/pi/g, 'PI').replace(/\be\b/g, 'exp(1)'),
                            color: '#6c757d',
                            graphType: 'polyline',
                            attr: { 'stroke-dasharray': '5,5' }
                        });
                    }
                } else if (funcs.length === 1) {
                    plotData.push({
                        fn: prep(inputs[0].value).replace(/pi/g, 'PI').replace(/\be\b/g, 'exp(1)'),
                        range: [a, b],
                        closed: true,
                        color: 'rgba(13, 110, 253, 0.4)',
                        graphType: 'polyline'
                    });
                }

                functionPlot({ 
                    target: '#plot-solver', 
                    width: document.getElementById('plot-solver').offsetWidth, 
                    height: document.getElementById('plot-solver').offsetHeight, 
                    grid: true, 
                    xAxis: { domain: [Math.min(a, b) - margin, Math.max(a, b) + margin] }, 
                    data: plotData 
                });
            } catch (err) {}
        }

        function attachSolverListeners(el) {
            el.addEventListener('input', (e) => { convertPi(e.target); updateSolverPreview(); updateSolverPlot(); });
        }

        function updateSolverButtons() {
            const container = document.getElementById('functions-container');
            const addBtn = document.getElementById('add-function');
            const subBtn = document.getElementById('subtract-function');
            if (container.children.length >= 2) {
                addBtn.style.display = 'none';
                subBtn.style.display = 'none';
            } else {
                addBtn.style.display = 'inline-block';
                subBtn.style.display = 'inline-block';
            }
        }

        document.getElementById('add-function').addEventListener('click', () => {
            currentOp = '+';
            const container = document.getElementById('functions-container');
            if (container.children.length >= 2) return;
            const div = document.createElement('div');
            div.className = 'col-12 col-md-6 function-input-group';
            div.innerHTML = `<label class="form-label">Function 2 (g(x))</label><div class="input-group"><input type="text" class="form-control formula-input" placeholder="e.g., x" value="x"><button class="btn btn-outline-danger btn-remove" type="button">&times;</button></div>`;
            container.appendChild(div);
            attachSolverListeners(div.querySelector('input'));
            div.querySelector('.btn-remove').addEventListener('click', () => { 
                div.remove(); 
                updateSolverButtons();
                updateSolverPreview(); 
                updateSolverPlot(); 
            });
            updateSolverButtons();
            updateSolverPreview(); 
            updateSolverPlot();
        });

        document.getElementById('subtract-function').addEventListener('click', () => {
            currentOp = '-';
            document.getElementById('add-function').click();
        });

        ['lower', 'upper'].forEach(id => document.getElementById(id).addEventListener('input', () => { convertPi(document.getElementById(id)); updateSolverPreview(); updateSolverPlot(); }));
        document.querySelectorAll('.formula-input').forEach(attachSolverListeners);

        // --- Mode Switching ---
        const btnToSolver = document.getElementById('switch-to-solver');
        const btnToGame = document.getElementById('switch-to-game');

        btnToSolver.addEventListener('click', () => {
            gameUI.style.display = 'none';
            startScreen.style.display = 'none';
            solverUI.style.display = 'block';
            btnToSolver.style.display = 'none';
            btnToGame.style.display = 'inline-block';
            if (timerId) clearInterval(timerId);
            updateSolverPlot();
        });

        btnToGame.addEventListener('click', () => {
            solverUI.style.display = 'none';
            startScreen.style.display = 'block';
            btnToSolver.style.display = 'inline-block';
            btnToGame.style.display = 'none';
        });

        window.onresize = () => {
            if (gameUI.style.display !== 'none') updateGamePlot();
            if (solverUI.style.display !== 'none') updateSolverPlot();
        };

        window.onload = () => { updateSolverPreview(); updateSolverPlot(); };

    </script>

</body>

</html>